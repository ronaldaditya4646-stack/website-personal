from ultralytics import YOLO
import cv2
import time
import numpy as np

# === Load model YOLOv8 ===
model = YOLO("yolov8n.pt")

# === Buka kamera (0 = default webcam) ===
cam = cv2.VideoCapture(0)

# === Set resolusi kamera ===
FRAME_WIDTH = 640
FRAME_HEIGHT = 480
cam.set(cv2.CAP_PROP_FRAME_WIDTH, FRAME_WIDTH)
cam.set(cv2.CAP_PROP_FRAME_HEIGHT, FRAME_HEIGHT)

if not cam.isOpened():
    print("Kamera tidak bisa dibuka.")
    exit()

# === Kalibrasi skala piksel ke cm ===
DISTANCE_CM = 30         # jarak kamera ke objek (cm)
PIXEL_TO_CM = DISTANCE_CM / FRAME_HEIGHT  # skala 1 px = X cm

print("Tekan 'q' untuk keluar...")

prev_time = 0

# === Fungsi untuk deteksi warna dominan ===
def detect_dominant_color(image):
    hsv = cv2.cvtColor(image, cv2.COLOR_BGR2HSV)
    avg_color = np.mean(hsv.reshape(-1, 3), axis=0)
    h, s, v = avg_color

    if s < 50 and v > 200:
        return "White", (255, 255, 255)
    elif v < 50:
        return "Black", (0, 0, 0)
    elif h < 15 or h > 165:
        return "Red", (0, 0, 255)
    elif 15 <= h < 35:
        return "Yellow", (0, 255, 255)
    elif 35 <= h < 85:
        return "Green", (0, 255, 0)
    elif 85 <= h < 125:
        return "Blue", (255, 0, 0)
    elif 125 <= h < 165:
        return "Purple", (255, 0, 255)
    else:
        return "Unknown", (200, 200, 200)

while True:
    ret, frame = cam.read()
    if not ret:
        break

    frame = cv2.flip(frame, 1)

    # === Hitung FPS ===
    curr_time = time.time()
    fps = 1 / (curr_time - prev_time + 1e-6)
    prev_time = curr_time

    # === Jalankan deteksi YOLO ===
    results = model(frame, stream=True)

    for r in results:
        boxes = r.boxes
        for box in boxes:
            x1, y1, x2, y2 = map(int, box.xyxy[0])
            w_px = x2 - x1
            h_px = y2 - y1
            w_cm = w_px * PIXEL_TO_CM
            h_cm = h_px * PIXEL_TO_CM

            cls = int(box.cls[0])
            conf = float(box.conf[0])
            label = model.names[cls]

            # === Crop area objek dan deteksi warna ===
            obj_crop = frame[y1:y2, x1:x2]
            if obj_crop.size > 0:
                color_name, color_bgr = detect_dominant_color(obj_crop)
            else:
                color_name, color_bgr = ("Unknown", (200, 200, 200))

            # === Gambar bounding box + teks warna dominan ===
            cv2.rectangle(frame, (x1, y1), (x2, y2), color_bgr, 2)
            cv2.putText(frame, f"{label} {conf:.2f} | {color_name}",
                        (x1, y1 - 10), cv2.FONT_HERSHEY_SIMPLEX, 0.6, color_bgr, 2)
            cv2.putText(frame, f"W:{w_cm:.2f}cm H:{h_cm:.2f}cm",
                        (x1, y2 + 20), cv2.FONT_HERSHEY_SIMPLEX, 0.6, color_bgr, 2)

    # === Tampilkan FPS ===
    cv2.putText(frame, f"FPS: {fps:.1f}", (10, 30),
                cv2.FONT_HERSHEY_SIMPLEX, 0.8, (0, 255, 255), 2)

    cv2.imshow("Deteksi Barang + Ukuran + Warna (cm) - YOLOv8", frame)

    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cam.release()
cv2.destroyAllWindows()
